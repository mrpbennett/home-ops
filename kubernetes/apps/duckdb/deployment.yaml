apiVersion: apps/v1
kind: Deployment
metadata:
  name: duckdb
  namespace: duckdb
  labels:
    app: duckdb
spec:
  replicas: 1
  strategy:
    type: Recreate # Important: DuckDB is single-instance
  selector:
    matchLabels:
      app: duckdb
  template:
    metadata:
      labels:
        app: duckdb
    spec:
      hostNetwork: true # Required for DuckDB UI to work properly
      dnsPolicy: ClusterFirstWithHostNet
      containers:
        - name: duckdb
          image: duckdb/duckdb:latest
          imagePullPolicy: Always
          # Explicitly set the command to use duckdb binary
          command:
            - duckdb
          args:
            - /workspace/duckdb.db
            - -init
            - /init/init.sql
          stdin: true
          tty: true
          volumeMounts:
            - name: data
              mountPath: /workspace
            - name: init-scripts
              mountPath: /init
          resources:
            requests:
              memory: '512Mi'
              cpu: '500m'
            limits:
              memory: '2Gi'
              cpu: '2000m'
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: duckdb-data
        - name: init-scripts
          configMap:
            name: duckdb-init
            items:
              - key: init.sql
                path: init.sql
