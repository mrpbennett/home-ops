apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: loki-stack
  namespace: argocd
spec:
  destination:
    server: "https://kubernetes.default.svc"
    namespace: logging
  project: default
  source:
    chart: loki-stack
    repoURL: https://grafana.github.io/helm-charts
    targetRevision: 2.10.2
    helm:
      valuesObject:
        loki:
          enabled: true
          isDefault: true
          url: http://loki.home.local:{{ .Values.loki.service.port }}
          readinessProbe: {}
          livenessProbe: {}

          ingress:
            enabled: true
            ingressClassName: nginx
            paths:
              distributor:
                - /api/prom/push
                - /loki/api/v1/push
                - /otlp/v1/logs
            hosts:
              - host: loki.home.local

        promtail:
          enabled: true
          config:
            logLevel: info
            serverPort: 3101
            clients:
              - url: http://loki.home.local:3100/loki/api/v1/push

        fluent-bit:
          enabled: false

        filebeat:
          enabled: false
          filebeatConfig:
            filebeat.yml: |
              # logging.level: debug
              filebeat.inputs:
              - type: container
                paths:
                  - /var/log/containers/*.log
                processors:
                - add_kubernetes_metadata:
                    host: ${NODE_NAME}
                    matchers:
                    - logs_path:
                        logs_path: "/var/log/containers/"
              output.logstash:
                hosts: ["logstash-loki:5044"]

        logstash:
          enabled: false
          image: grafana/logstash-output-loki
          imageTag: 1.0.1
          filters:
            main: |-
              filter {
                if [kubernetes] {
                  mutate {
                    add_field => {
                      "container_name" => "%{[kubernetes][container][name]}"
                      "namespace" => "%{[kubernetes][namespace]}"
                      "pod" => "%{[kubernetes][pod][name]}"
                    }
                    replace => { "host" => "%{[kubernetes][node][name]}"}
                  }
                }
                mutate {
                  remove_field => ["tags"]
                }
              }
          outputs:
            main: |-
              output {
                loki {
                  url => "http://loki:3100/loki/api/v1/push"
                  #username => "test"
                  #password => "test"
                }
                # stdout { codec => rubydebug }
              }

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
