apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: vault
  namespace: argocd
spec:
  destination:
    server: "https://kubernetes.default.svc"
    namespace: vault
  project: k3s
  source:
    chart: vault
    repoURL: https://charts.bitnami.com/bitnami
    targetRevision: 1.4.23
    helm:
      valuesObject:
        clusterDomain: cluster.local

        server:
          enabled: true
          replicaCount: 1
          containerPorts:
            http: 8200
            internal: 8201

          livenessProbe:
            enabled: false
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 5
            successThreshold: 1

          readinessProbe:
            enabled: true
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 5
            successThreshold: 1

          startupProbe:
            enabled: false
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 5
            successThreshold: 1

          resourcesPreset: nano

          config: |
            disable_mlock = true

            ui = true

            listener "tcp" {
              tls_disable = 1
              address = "[::]:{{ .Values.server.containerPorts.http }}"
              cluster_address = "[::]:{{ .Values.server.containerPorts.internal }}"
              {{- if .Values.server.metrics.enabled }}
              # Enable unauthenticated metrics access (necessary for Prometheus Operator)
              telemetry {
                unauthenticated_metrics_access = "true"
              }
              {{- end }}
            }

            storage "raft" {
              path = "{{ .Values.server.persistence.mountPath }}"
            }

            service_registration "kubernetes" {}

          service:
            general:
              type: ClusterIP
              ports:
                http: 8200
                internal: 8201
              annotations:
                kube-vip.io/loadbalancerIPs: 192.168.5.62

            active:
              type: ClusterIP
              ports:
                http: 8200
                internal: 8201
              annotations:
                kube-vip.io/loadbalancerIPs: 192.168.5.63

          ingress:
            enabled: true
            pathType: ImplementationSpecific
            hostname: vault.70ld.home
            ingressClassName: nginx
            path: /

          rbac:
            create: true

          serviceAccount:
            create: true

          persistence:
            enabled: true
            mountPath: /bitnami/vault/data
            storageClass: longhorn
            accessMode:
              - ReadWriteOnce
            size: 10Gi

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
