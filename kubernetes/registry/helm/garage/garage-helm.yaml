apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: garage
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://git.deuxfleurs.fr/Deuxfleurs/garage.git
    targetRevision: main-v2
    path: script/helm/garage
    helm:
      releaseName: garage
      valuesObject:
        garage:
          dbEngine: 'lmdb'
          blockSize: '1048576'
          replicationMode: '3'
          compressionLevel: '1'
          s3:
            api:
              region: 'garage'
              rootDomain: '.s3.garage.70ld.dev' # Fixed: use your actual domain
            web:
              rootDomain: '.web.garage.70ld.dev' # Fixed: use your actual domain
              index: 'index.html'

        # For Raspberry Pi deployment - consider using PVCs instead of hostPath
        persistence:
          enabled: true
          meta:
            size: 1Gi # Increased from 100Mi for better performance
            # Use PVC instead of hostPath for better reliability
            # storageClass: "local-path"  # Uncomment and adjust for your storage class
            hostPath: /var/lib/garage/meta
          data:
            size: 10Gi # Increased from 100Mi for actual storage
            # storageClass: "local-path"  # Uncomment and adjust for your storage class
            hostPath: /var/lib/garage/data

        deployment:
          kind: StatefulSet
          replicaCount: 1
          podManagementPolicy: OrderedReady

        # Image configuration for ARM64 (Raspberry Pi)
        image:
          repository: dxflrs/arm64_garage # ARM64 image for Raspberry Pi
          pullPolicy: IfNotPresent

        ingress:
          s3:
            api:
              enabled: true
              className: nginx
              annotations:
                cert-manager.io/cluster-issuer: 'letsencrypt-cloudflare-dns-issuer'
                # Add body size limit for S3 uploads
                nginx.ingress.kubernetes.io/proxy-body-size: '1024m'
                # Add timeout configurations for large uploads
                nginx.ingress.kubernetes.io/proxy-connect-timeout: '600'
                nginx.ingress.kubernetes.io/proxy-send-timeout: '600'
                nginx.ingress.kubernetes.io/proxy-read-timeout: '600'
              hosts:
                - host: 's3.garage.70ld.dev'
                  paths:
                    - path: /
                      pathType: Prefix
                # For S3 virtual-hosted-style requests (bucket.s3.garage.70ld.dev)
                - host: '*.s3.garage.70ld.dev'
                  paths:
                    - path: /
                      pathType: Prefix
              tls:
                - secretName: garage-s3-tls
                  hosts:
                    - s3.garage.70ld.dev
                    - '*.s3.garage.70ld.dev'

            web:
              enabled: true
              className: nginx
              annotations:
                cert-manager.io/cluster-issuer: 'letsencrypt-cloudflare-dns-issuer'
              hosts:
                # For website hosting (bucket.web.garage.70ld.dev)
                - host: '*.web.garage.70ld.dev'
                  paths:
                    - path: /
                      pathType: Prefix
                # Main web interface
                - host: 'garage-web.70ld.dev'
                  paths:
                    - path: /
                      pathType: Prefix
              tls:
                - secretName: garage-web-tls
                  hosts:
                    - '*.web.garage.70ld.dev'
                    - garage-web.70ld.dev

        # Resource limits appropriate for Raspberry Pi
        resources:
          limits:
            cpu: 500m # Increased for better performance
            memory: 1024Mi
          requests:
            cpu: 100m
            memory: 256Mi # Increased from 128Mi

        # Security context for non-root execution
        podSecurityContext:
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
          fsGroupChangePolicy: 'OnRootMismatch'
          runAsNonRoot: true

        securityContext:
          capabilities:
            drop:
              - ALL
          readOnlyRootFilesystem: true

        # Health checks
        livenessProbe:
          httpGet:
            path: /health
            port: 3903
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3

        readinessProbe:
          httpGet:
            path: /health
            port: 3903
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        # Node selector for Raspberry Pi if you have mixed architecture
        # nodeSelector:
        #   kubernetes.io/arch: arm64

  destination:
    server: https://kubernetes.default.svc
    namespace: garage

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - Validate=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        maxDuration: 5m0s
        factor: 2
